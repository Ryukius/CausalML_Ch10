"0","# Least squares model average"
"0","# We'll look at weights that do best job for Y overall. Could also use different weights for Y0 and Y1"
"0",""
"0","ma_dw <- lm(D ~ dhat_lasso + dhat_rf + dhat_tr + dhat_boost)$coef"
"0","ma_yw <- lm(y ~ yhat_lasso + dhat_rf + yhat_tr + yhat_boost)$coef"
"0",""
"0","Dhats <- cbind(as.matrix(rep(1, nrow(X))), dhat_lasso, dhat_rf, dhat_tr, dhat_boost)"
"0","Y0s <- cbind(as.matrix(rep(1, nrow(X))), yhat0_lasso, yhat0_rf, yhat0_tr, yhat0_boost)"
"0","Y1s <- cbind(as.matrix(rep(1, nrow(X))), yhat1_lasso, yhat1_rf, yhat1_tr, yhat1_boost)"
"0",""
"0","dhat <- Dhats %*% as.matrix(ma_dw)"
"0","yhat0 <- Y0s %*% as.matrix(ma_yw)"
"0","yhat1 <- Y1s %*% as.matrix(ma_yw)"
"0",""
"0","# Prediction of treatment and outcome for observed instrument"
"0","yhat <- yhat0 * (1 - D) + yhat1 * D"
"0","# residuals"
"0","ytil <- y - yhat"
"0","dtil <- D - dhat"
"0","# doubly robust quantity for every sample"
"0","drhat <- yhat1 - yhat0 + (y - yhat) * (D / dhat - (1 - D) / (1 - dhat))"
"0","coef_est <- mean(drhat)"
"0","vari <- var(drhat)"
"0","se <- sqrt(vari / nrow(X))"
"0",""
"0","sum.ma <- summaryIRM(coef_est, se, ytil, dtil, drhat, name = ""Model Average"")"
"0","tableirm <- rbind(tableirm, sum.ma)"
"0","tableirm"
